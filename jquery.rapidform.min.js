(function(a){a.fn.rapidForm=function(c){var h=a(this),f,g,e,b,d;g={submit:".submit",submitContinue:".continue",remove:".remove",cancel:".cancel",formGroup:".form-group",helpBlock:".help-block",formGroupClass:"has-error",helpBlockIcon:'<i class="fa fa-warning"></i>',confirmMessage:"Are you sure?",confirm:function(j){var k=new a.Deferred;(confirm(e.confirmMessage))?k.resolve():k.reject();return k.promise()},submited:null,dialog:null,urlAdd:"",titleAdd:"Create",titleEdit:"Edit",width:"80%",template:"#template",container:"tbody",row:"tr:visible",insertAfter:null,insertBefore:null,open:null,heightTextare:true};e=a.extend({},g,c);b=function(l,q,p,n){var k,o,r,j;if(!n){n=l}for(k in q){o=(k)?n.find(k):n;r=(k)?l.find(k):n;if(o.length){attrs=q[k].split(/ *, */);for(i=0;i<attrs.length;i++){j=attrs[i];switch(j){case"text":o.each(function(s){var u=a(this),t;if(str=u.text()){if(m=str.match(/\{(.+)\}/)){key=m[1];if(p[key]!=null){t=RegExp("{"+key+"}");str=str.replace(t,p[key]);r.eq(s).text(str)}}}});break;case"data-raw":str=JSON.stringify(p);r.get(0).setAttribute("data-raw",str);break;default:r.each(function(s){var u=a(this),t;if(str=u.attr(j)){if(m=str.match(/\{(.+)\}/)){key=m[1];if(p[key]!=null){t=RegExp("{"+key+"}");str=str.replace(t,p[key]);r.eq(s).attr(j,str)}}}});break}}}}};h.each(function(){var j=a(this);j.find(e.submit+","+e.submitContinue).filter(":button").click(function(){var k=a(this);j.find(e.helpBlock).text("").hide();j.find(e.formGroup).removeClass(e.formGroupClass);a.ajax({url:j.attr("action"),data:new FormData(j[0]),contentType:false,processData:false,type:"post",dataType:"json"}).done(function(q){var p,o,t,n,s,r,l;if(q&&q.errors){for(p in q.errors){o=j.find('[name="'+p+'"],[for="'+p+'"]').parents(e.formGroup);t=o.find(e.helpBlock);o.addClass(e.formGroupClass);t.show().html(e.helpBlockIcon+q.errors[p])}return}if(e.submited){e.submited(j,q)}if(q){if(q.reload){location.reload();return}if(q.redirect){location.href=q.redirect;return}}if(e.dialog&&j.parents(e.dialog).length&&k.is(e.submit)){a(e.dialog).dialog("close")}else{if(q&&q.form=="clear"||k.is(e.submitContinue)){j.find("input:not(:checkbox,:radio), textarea").val("")}}if(q&&q.raw){n=a(e.template).clone().show();s=n.data("template");n.removeAttr("id data-template");if(f){$current=f.parents(e.row+":first");b($current,s,q.raw,n)}else{b(n,s,q.raw);r=a(e.container);l=null;if(e.insertAfter){index=e.insertAfter(r,q.raw);if(index!=null){l=r.find(e.row).eq(index);n.insertAfter(l)}}else{if(e.insertBefore){index=e.insertBefore(r,q.raw);if(index!=null){l=r.find(e.row).eq(index);n.insertBefore(l)}}}if(!l){n.appendTo(r)}}}})});j.find(e.remove).click(function(){e.confirm(j).done(function(){j.find(e.helpBlock).text("").hide();j.find(e.formGroup).removeClass(e.formGroupClass);a.ajax({url:j.attr("action").replace(/\/edit$/,"/remove"),type:"get",dataType:"json"}).done(function(n){var l,k,o;if(n&&n.errors){for(l in n.errors){k=j.find('[name="'+l+'"],[for="'+l+'"]').parents(e.formGroup);o=k.find(e.helpBlock);k.addClass(e.formGroupClass);o.show().html(e.helpBlockIcon+n.errors[l])}return}if(n){if(n.reload){location.reload();return}if(n.redirect){location.href=n.redirect;return}}if(e.dialog&&j.parents(e.dialog).length){a(e.dialog).dialog("close")}if(f){f.parents(e.row+":first").remove()}})})});if(j.find(":submit").length==0&&j.find(".btn-primary:button").length>0){j.find("input,textarea").keypress(function(k){var l=a(k.currentTarget),n=k.charCode||k.keyCode;if(n==13){if(l.is("textarea")){return}if(l.is(":not(:checkbox,:radio)")){j.find(".btn-primary:button").eq(0).click()}return false}})}});d=function(k,l,j,n){$dialog=a(k);if(j){$dialog.find("form").attr("action",j)}if(!$dialog.find(e.helpBlock).text().length){$dialog.find("input, textarea, select").each(function(){var q=a(this),p=q.attr("name"),r=q.attr("type"),o,s;if(r=="radio"||r=="checkbox"){if(n){q.prop("checked",(q.val()==n[p]))}}else{if(n){q.val(str=n[p]);if(e.heightTextare&&q.is("textarea")&&str.length){o=str.match(/\n/);s=(o)?o.length+1:1;q.css("height",(s*3)+"em")}}else{q.val("")}}})}if(n){$remove=$dialog.find(e.remove).show();if($remove.is("a")&&j){$remove.attr("href",j.replace(/\/edit$/,"/remove")).show()}$dialog.find(".add-disabled").prop("disabled",false);$dialog.find(".edit-disabled").prop("disabled",true);$dialog.find(".add-hide").show();$dialog.find(".edit-hide").hide()}else{$dialog.find(".remove").hide();$dialog.find(".add-disabled").prop("disabled",true);$dialog.find(".edit-disabled").prop("disabled",false);$dialog.find(".add-hide").hide();$dialog.find(".edit-hide").show()}$dialog.dialog({title:l,width:e.width,modal:true,open:e.open,close:function(){$dialog.find(e.helpBlock).text("").hide();$dialog.find(e.formGroup).removeClass(e.formGroupClass)}});$dialog.find(e.cancel).filter(":button").unbind("click").click(function(){$dialog.dialog("close")})};a.fn.rapidForm.clickAdd=function(){f=null;d(e.dialog,e.titleAdd,e.urlAdd)};a.fn.rapidForm.clickEdit=function(k){f=k;var j,l;j=f.data("action");if(!j){j=f.attr("href")}l=a.parseJSON(f.attr("data-raw"));d(e.dialog,e.titleEdit,j,l)};a.fn.rapidForm.clickCustom=function(k,l,j){f=null;d(k,l,j)};a(e.helpBlock+":visible").parents(e.formGroup).addClass(e.formGroupClass);return h}})(jQuery);